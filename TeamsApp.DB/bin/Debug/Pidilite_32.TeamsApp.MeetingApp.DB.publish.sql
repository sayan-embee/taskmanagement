/*
Deployment script for PidiliteMeetingAppPhase2

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "PidiliteMeetingAppPhase2"
:setvar DefaultFilePrefix "PidiliteMeetingAppPhase2"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Starting rebuilding table [dbo].[Trn_MeetingDetails]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Trn_MeetingDetails] (
    [MeetingId]          BIGINT         IDENTITY (1, 1) NOT NULL,
    [MeetingTypeId]      INT            NOT NULL,
    [MeetingTitleId]     INT            NOT NULL,
    [TeamsId]            NVARCHAR (200) NULL,
    [ChannelId]          NVARCHAR (200) NULL,
    [ChannelName]        NVARCHAR (200) NULL,
    [LocationId]         NVARCHAR (100) NULL,
    [LocationName]       NVARCHAR (100) NULL,
    [MeetingDescription] NTEXT          NOT NULL,
    [CreatedBy]          NVARCHAR (100) NULL,
    [CreatedOn]          DATETIME       NULL,
    [CreatedByEmail]     NVARCHAR (100) NULL,
    [CreatedByADID]      NVARCHAR (50)  NULL,
    [UpdatedBy]          NVARCHAR (100) NULL,
    [UpdatedOn]          DATETIME       NULL,
    [UpdatedByEmail]     NVARCHAR (100) NULL,
    [UpdatedByADID]      NVARCHAR (50)  NULL,
    [DivisionId]         INT            NULL,
    [DivisionName]       NVARCHAR (100) NULL,
    [VerticalId]         INT            NULL,
    [VerticalName]       NVARCHAR (100) NULL,
    [TimeZone]           NVARCHAR (200) NULL,
    [StartDateTime]      DATETIME       NOT NULL,
    [EndDateTime]        DATETIME       NOT NULL,
    [AllDayEvent]        BIT            NULL,
    [RepeatOption]       NVARCHAR (100) NOT NULL,
    [AnchorName]         NVARCHAR (100) NULL,
    [AnchorEmail]        NVARCHAR (100) NULL,
    [AnchorADID]         NVARCHAR (100) NULL,
    [AnchorDivisionId]   INT            NULL,
    [AnchorDivisionName] NVARCHAR (100) NULL,
    [AnchorVerticalId]   INT            NULL,
    [AnchorVerticalName] NVARCHAR (100) NULL,
    [ICalUId]            NVARCHAR (500) NULL,
    [EventId]            NVARCHAR (500) NULL,
    [JoinUrl]            NVARCHAR (500) NULL,
    [SeriesMasterId]     NVARCHAR (500) NULL,
    [MeetingStatus]      NVARCHAR (50)  NOT NULL,
    [StartDateTimeUTC]   DATETIME       NULL,
    [EndDateTimeUTC]     DATETIME       NULL,
    [EventType]          NVARCHAR (50)  NULL,
    [ChatId]             NVARCHAR (500) NULL,
    [OrganiserName]      NVARCHAR (100) NULL,
    [OrganiserEmail]     NVARCHAR (100) NULL,
    [OrganiserADID]      NVARCHAR (100) NULL,
    [ParentMeetingId]    BIGINT         NULL,
    [CancelRemark]       NVARCHAR (200) NULL,
    [MeetingTitle]       NVARCHAR (500) NULL,
    [IsConducted]        BIT            NULL,
    [IsActive]           BIT            NULL,
    PRIMARY KEY CLUSTERED ([MeetingId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Trn_MeetingDetails])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Trn_MeetingDetails] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Trn_MeetingDetails] ([MeetingId], [MeetingTypeId], [MeetingTitleId], [TeamsId], [ChannelId], [ChannelName], [LocationId], [LocationName], [MeetingDescription], [CreatedBy], [CreatedOn], [CreatedByEmail], [CreatedByADID], [UpdatedBy], [UpdatedOn], [UpdatedByEmail], [UpdatedByADID], [DivisionId], [DivisionName], [VerticalId], [VerticalName], [TimeZone], [StartDateTime], [EndDateTime], [AllDayEvent], [RepeatOption], [AnchorName], [AnchorEmail], [AnchorADID], [ICalUId], [EventId], [JoinUrl], [SeriesMasterId], [MeetingStatus], [StartDateTimeUTC], [EndDateTimeUTC], [EventType], [ChatId], [OrganiserName], [OrganiserEmail], [OrganiserADID], [ParentMeetingId], [CancelRemark], [MeetingTitle], [IsConducted], [IsActive])
        SELECT   [MeetingId],
                 [MeetingTypeId],
                 [MeetingTitleId],
                 [TeamsId],
                 [ChannelId],
                 [ChannelName],
                 [LocationId],
                 [LocationName],
                 [MeetingDescription],
                 [CreatedBy],
                 [CreatedOn],
                 [CreatedByEmail],
                 [CreatedByADID],
                 [UpdatedBy],
                 [UpdatedOn],
                 [UpdatedByEmail],
                 [UpdatedByADID],
                 [DivisionId],
                 [DivisionName],
                 [VerticalId],
                 [VerticalName],
                 [TimeZone],
                 [StartDateTime],
                 [EndDateTime],
                 [AllDayEvent],
                 [RepeatOption],
                 [AnchorName],
                 [AnchorEmail],
                 [AnchorADID],
                 [ICalUId],
                 [EventId],
                 [JoinUrl],
                 [SeriesMasterId],
                 [MeetingStatus],
                 [StartDateTimeUTC],
                 [EndDateTimeUTC],
                 [EventType],
                 [ChatId],
                 [OrganiserName],
                 [OrganiserEmail],
                 [OrganiserADID],
                 [ParentMeetingId],
                 [CancelRemark],
                 [MeetingTitle],
                 [IsConducted],
                 [IsActive]
        FROM     [dbo].[Trn_MeetingDetails]
        ORDER BY [MeetingId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Trn_MeetingDetails] OFF;
    END

DROP TABLE [dbo].[Trn_MeetingDetails];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Trn_MeetingDetails]', N'Trn_MeetingDetails';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Altering Procedure [dbo].[usp_Dashboard_Personal_MeetingDetails]...';


GO
ALTER PROCEDURE [dbo].[usp_Dashboard_Personal_MeetingDetails]
@UserEmail VARCHAR(100),
	@FromDate DATETIME,
	@ToDate DATETIME
AS
--Declare @UserEmail VARCHAR(100) = 'demouser1@surajdevembee.onmicrosoft.com', --'admin@surajdevembee.onmicrosoft.com',
--	@FromDate DATETIME = NULL,
--	@ToDate DATETIME = NULL
--------------------------------
--EXEC usp_Dashboard_Personal_MeetingDetails 'admin@surajdevembee.onmicrosoft.com', NULL, NULL
--------------------------------
BEGIN
	DECLARE @MeetingData AS TABLE
	(
		MeetingId BIGINT,
		MeetingTypeId INT,
		TypeName VARCHAR(100),
		MeetingTitleId INT,
		MeetingTitle VARCHAR(500),
		AnchorEmail VARCHAR(100),
		OrganiserEmail VARCHAR(100),
		StartDateTime DATETIME,
		EndDateTime DATETIME,
		AnchorADID VARCHAR(100),
		IsConducted INT
	)
	INSERT INTO @MeetingData
	(
		MeetingId
		,MeetingTypeId
		,TypeName
		,MeetingTitleId
		,MeetingTitle
		,AnchorEmail
		,OrganiserEmail
		,StartDateTime
		,EndDateTime
		,AnchorADID
		,IsConducted
	)
	SELECT 
		MD.MeetingId
		,MD.MeetingTypeId
		,MType.TypeName
		,MD.MeetingTitleId
		,MD.MeetingTitle
		,MD.AnchorEmail
		,MD.OrganiserEmail
		,MD.StartDateTime
		,MD.EndDateTime
		,AnchorADID
		,MD.IsConducted
	FROM dbo.[Trn_MeetingDetails] MD WITH(NOLOCK)
	INNER JOIN dbo.Mst_MeetingType MType ON MD.MeetingTypeId = MType.TypeId
	WHERE (CONVERT(DATE,MD.StartDateTime,103) >= CONVERT(DATE,@FromDate,103) OR @FromDate IS NULL)
    AND (CONVERT(DATE,MD.StartDateTime,103) <= CONVERT(DATE,@ToDate,103)  OR @ToDate IS NULL)
    AND  (MD.AnchorEmail = @UserEmail OR MD.OrganiserEmail = @UserEmail
	OR 
	MeetingId IN (SELECT MeetingId FROM Trn_MeetingParticipants P WHERE P.ParticipantEmail = @UserEmail and Active = 1))
	AND MD.IsActive = 1
    ORDER BY MD.StartDateTime,MD.EndDateTime,MD.CreatedOn DESC

	-----------------Type Wise Grouping Start--------------------
	DECLARE @TypeTEMP AS TABLE
	(	MeetingTypeId INT,
		TypeName VARCHAR(100),
		TotalScheduledMeetingsAnchor INT DEFAULT 0,
		TotalConductedMeetingsAnchor INT DEFAULT 0,
		TotalDocumentUploaded		 INT DEFAULT 0,
		TotalParticipant			 INT DEFAULT 0,
		TotalTimeSpentAnchor		 VARCHAR(100),
		TotalAttendedParticipant	 INT DEFAULT 0,
		TotalTimeSpentParticipant	 VARCHAR(100)
	)

	INSERT INTO @TypeTEMP(MeetingTypeId,TypeName)
	SELECT DISTINCT TypeId AS MeetingTypeId,TypeName
	FROM Mst_MeetingType

	UPDATE @TypeTEMP
	SET TotalScheduledMeetingsAnchor=X.CNT
	FROM @TypeTEMP T,
	(SELECT COUNT(*) CNT,MeetingTypeId--,MeetingTitleId
	FROM @MeetingData 
	WHERE AnchorEmail=@UserEmail
	GROUP BY MeetingTypeId--,MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	
	UPDATE @TypeTEMP
	SET TotalConductedMeetingsAnchor=X.CNT
	FROM @TypeTEMP T,
	(SELECT COUNT(*) CNT,MeetingTypeId--,MeetingTitleId
	FROM @MeetingData 
	
	WHERE AnchorEmail=@UserEmail 
	AND IsConducted = 1
	--AND (CONVERT(DATE,StartDateTime,103) < CONVERT(DATE,DATEADD(MINUTE,330,GETUTCDATE()),103))
	GROUP BY MeetingTypeId--,MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId

	UPDATE @TypeTEMP
	SET TotalDocumentUploaded = X.CNT
	FROM @TypeTEMP T,
	(SELECT COUNT(*) CNT,MeetingTypeId--,MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_MeetingFileUpload FU ON MDET.MeetingId = FU.MeetingId
	GROUP BY MeetingTypeId--,MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId

	UPDATE @TypeTEMP
	SET TotalParticipant = X.CNT
	FROM @TypeTEMP T,
	(SELECT COUNT(*) CNT,MDET.MeetingTypeId--,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	WHERE ParticipantEmail = @UserEmail
	GROUP BY MDET.MeetingTypeId--,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	
	-----TotalTimeSpentAnchor------
	UPDATE @TypeTEMP
	SET TotalTimeSpentAnchor = X.CNT
	FROM @TypeTEMP T,
	--(SELECT COUNT(*) CNT,MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId
	--FROM @MeetingData MDET
	--INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	--WHERE ParticipantEmail = @UserEmail
	--GROUP BY MDET.MeetingTypeId--,MDET.MeetingTitleId
	--)
	(SELECT CAST((CAST(SUM( DATEDIFF(minute, CS.StartDateTime, CS.EndDateTime)) AS FLOAT) / 60 )AS NUMERIC(18,2)) CNT,MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_CallRecords CR ON CR.MeetingId = MDET.MeetingId
	INNER JOIN Trn_CallRecordSessions CS ON CS.CallRecordId = CR.Id
	--INNER JOIN Trn_MeetingParticipants MP ON CS.CallerADId = MP.ParticipantADID
	WHERE  CR.OrganiserADId = MDET.AnchorADID
	AND MDET.OrganiserEmail = @UserEmail
	--CS.CallerADId = MDET.AnchorADID
	GROUP BY MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	-----------

	-----TotalAttendedParticipant------
	UPDATE @TypeTEMP
	SET TotalAttendedParticipant = X.CNT
	FROM @TypeTEMP T,
	(
	SELECT COUNT (*) CNT,MDET.MeetingId,MDET.MeetingTypeId
	--,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_CallRecords CR ON CR.MeetingId = MDET.MeetingId
	INNER JOIN Trn_CallRecordParticipants CP ON CR.Id = CP.CallRecordId
	INNER JOIN Trn_MeetingParticipants MP ON MP.MeetingId = MDET.MeetingId 
	AND MP.ParticipantADID = CP.ParticipantADId
	WHERE MP.ParticipantEmail = @UserEmail 
	AND MDET.AnchorEmail != @UserEmail
	--ParticipantEmail = @UserEmail
	GROUP BY MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId

	--SELECT COUNT (DISTINCT PARTICIPANTNAME) CNT,CR.MeetingId,MDET.MeetingTypeId
	--FROM 
	--@MeetingData MDET INNER JOIN Trn_CallRecords CR  ON CR.MeetingId = MDET.MeetingId	
	--INNER JOIN Trn_CallRecordParticipants CP ON CR.Id = CP.CallRecordId
	--GROUP BY CR.MeetingId,MDET.MeetingTypeId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId


	-----------

	-----TotalTimeSpentParticipant------
	UPDATE @TypeTEMP
	SET TotalTimeSpentParticipant = X.CNT
	FROM @TypeTEMP T,
	--(SELECT COUNT(*) CNT,MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId
	--FROM @MeetingData MDET
	--INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	--WHERE ParticipantEmail = @UserEmail
	--GROUP BY MDET.MeetingTypeId--,MDET.MeetingTitleId
	--)
	(SELECT CAST((CAST(SUM( DATEDIFF(minute, CS.StartDateTime, CS.EndDateTime)) AS FLOAT) / 60 )AS NUMERIC(18,2)) CNT,MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_CallRecords CR ON CR.MeetingId = MDET.MeetingId
	INNER JOIN Trn_CallRecordSessions CS ON CS.CallRecordId = CR.Id
	INNER JOIN Trn_MeetingParticipants MP ON CS.CallerADId = MP.ParticipantADID
	WHERE MP.ParticipantEmail = @UserEmail 
	AND MDET.AnchorEmail != @UserEmail
	--CS.CallerADId = MDET.AnchorADID
	
	GROUP BY MDET.MeetingId,MDET.MeetingTypeId--,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	-----------
	-----------------Type Wise Grouping End--------------------

	-----------------Title Wise Grouping Start--------------------
	DECLARE @TEMP AS TABLE
	(	MeetingTypeId INT,
		MeetingTitleId INT,
		TotalScheduledMeetingsAnchor INT DEFAULT 0,
		TotalConductedMeetingsAnchor INT DEFAULT 0,
		TotalDocumentUploaded		 INT DEFAULT 0,
		TotalParticipant			 INT DEFAULT 0,
		TotalTimeSpentAnchor		 VARCHAR(100),
		TotalAttendedParticipant	 INT DEFAULT 0,
		TotalTimeSpentParticipant	 VARCHAR(100)
	)

	INSERT INTO @TEMP(MeetingTypeId,MeetingTitleId)
	SELECT DISTINCT MeetingTypeId,MeetingTitleId
	FROM Mst_MeetingTitle

	UPDATE @TEMP
	SET TotalScheduledMeetingsAnchor=X.CNT
	FROM @TEMP T,

	(SELECT COUNT(*) CNT,MeetingTypeId,MeetingTitleId
	FROM @MeetingData 
	WHERE AnchorEmail=@UserEmail
	GROUP BY MeetingTypeId,MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId

	UPDATE @TEMP
	SET TotalConductedMeetingsAnchor=X.CNT
	FROM @TEMP T,
	(SELECT COUNT(*) CNT,MeetingTypeId,MeetingTitleId
	FROM @MeetingData 
	WHERE AnchorEmail=@UserEmail 
	--AND (CONVERT(DATE,StartDateTime,103) < CONVERT(DATE,DATEADD(MINUTE,330,GETUTCDATE()),103))
	AND IsConducted = 1
	GROUP BY MeetingTypeId,MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId
	

	UPDATE @TEMP
	SET TotalDocumentUploaded = X.CNT
	FROM @TEMP T,
	(SELECT COUNT(*) CNT,MeetingTypeId,MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_MeetingFileUpload FU ON MDET.MeetingId = FU.MeetingId
	GROUP BY MeetingTypeId,MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId 

	UPDATE @TEMP
	SET TotalParticipant = X.CNT
	FROM @TEMP T,
	(SELECT COUNT(*) CNT,MDET.MeetingTypeId,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	WHERE ParticipantEmail = @UserEmail
	GROUP BY MDET.MeetingTypeId,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId 

	-----------TotalTimeSpentAnchor------------
	UPDATE @TEMP
	SET TotalTimeSpentAnchor = X.CNT
	FROM @TEMP T,
	--(SELECT COUNT(*) CNT,MDET.MeetingTypeId,MDET.MeetingTitleId
	--FROM @MeetingData MDET
	--INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	--WHERE ParticipantEmail = @UserEmail
	--GROUP BY MDET.MeetingTypeId,MDET.MeetingTitleId
	--)
	(SELECT CAST((CAST(SUM( DATEDIFF(minute, CS.StartDateTime, CS.EndDateTime)) AS FLOAT) / 60 )AS NUMERIC(18,2)) CNT,MDET.MeetingId,MDET.MeetingTypeId,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_CallRecords CR ON CR.MeetingId = MDET.MeetingId
	INNER JOIN Trn_CallRecordSessions CS ON CS.CallRecordId = CR.Id
	--INNER JOIN Trn_MeetingParticipants MP ON CS.CallerADId = MP.ParticipantADID
	WHERE  CR.OrganiserADId = MDET.AnchorADID
	AND MDET.OrganiserEmail = @UserEmail
	--WHERE CS.CallerADId = MDET.AnchorADID
	GROUP BY MDET.MeetingId,MDET.MeetingTypeId,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId 
	-----------------------

	-----------TotalAttendedParticipant------------
	UPDATE @TEMP
	SET TotalAttendedParticipant = X.CNT
	FROM @TEMP T,
	(SELECT COUNT(DISTINCT MDET.MeetingId) CNT,MDET.MeetingId,MDET.MeetingTypeId,MDET.MeetingTitleId
	FROM @MeetingData MDET
	--INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	INNER JOIN Trn_CallRecords CR ON CR.MeetingId = MDET.MeetingId
	INNER JOIN Trn_CallRecordParticipants CP ON CR.Id = CP.CallRecordId
	INNER JOIN Trn_MeetingParticipants MP ON MP.MeetingId = MDET.MeetingId 
	AND MP.ParticipantADID = CP.ParticipantADId
	WHERE MP.ParticipantEmail = @UserEmail 
	AND MDET.AnchorEmail != @UserEmail 
	--ParticipantEmail = @UserEmail
	GROUP BY MDET.MeetingId,MDET.MeetingTypeId,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId 
	-----------------------

	-----------TotalTimeSpentParticipant------------
	UPDATE @TEMP
	SET TotalTimeSpentParticipant = X.CNT
	FROM @TEMP T,
	--(SELECT COUNT(*) CNT,MDET.MeetingTypeId,MDET.MeetingTitleId
	--FROM @MeetingData MDET
	--INNER JOIN Trn_MeetingParticipants MP ON MDET.MeetingId = MP.MeetingId
	--WHERE ParticipantEmail = @UserEmail
	--GROUP BY MDET.MeetingTypeId,MDET.MeetingTitleId
	--)
	(SELECT CAST((CAST(SUM( DATEDIFF(minute, CS.StartDateTime, CS.EndDateTime)) AS FLOAT) / 60 )AS NUMERIC(18,2)) CNT,MDET.MeetingId,MDET.MeetingTypeId,MDET.MeetingTitleId
	FROM @MeetingData MDET
	INNER JOIN Trn_CallRecords CR ON CR.MeetingId = MDET.MeetingId
	INNER JOIN Trn_CallRecordSessions CS ON CS.CallRecordId = CR.Id
	INNER JOIN Trn_MeetingParticipants MP ON CS.CallerADId = MP.ParticipantADID
	WHERE MP.ParticipantEmail = @UserEmail
	AND MDET.AnchorEmail != @UserEmail

	--WHERE CS.CallerADId = MDET.AnchorADID
	GROUP BY MDET.MeetingId,MDET.MeetingTypeId,MDET.MeetingTitleId
	)
	X
	WHERE T.MeetingTypeId=X.MeetingTypeId
	AND T.MeetingTitleId=X.MeetingTitleId

	-----------------------
	-----------------Title Wise Grouping Start--------------------

	SELECT * FROM @TypeTEMP
	SELECT A.*,MT.MeetingTitle,T.TypeName--, MDET.MeetingId
	FROM @TEMP a
	INNER JOIN 	Mst_MeetingTitle MT WITH(NOLOCK) ON A.MeetingTitleId=MT.MeetingTitleId AND A.MeetingTypeId=MT.MeetingTypeId
	INNER JOIN 	Mst_MeetingType T WITH(NOLOCK) ON T.TypeId=MT.MeetingTypeId
	--INNER JOIN Trn_MeetingDetails MDET WITH(NOLOCK) ON MDET.MeetingTitleId = MT.MeetingTitleId
END
GO
PRINT N'Altering Procedure [dbo].[usp_MeetingDetails_Get]...';


GO
ALTER PROCEDURE [dbo].[usp_MeetingDetails_Get]
    @Id BIGINT = 0,
    @Date DATETIME = NULL,
    @ParentMeetingId BIGINT = NULL,
    @ChatId NVARCHAR(500) = NULL
AS
BEGIN
    IF(@Id = 0)
    BEGIN
        SET @Id = ( 
                    SELECT MeetingId 
                    FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
                    WHERE ChatId = @ChatId 
                    AND (CONVERT(DATE,StartDateTime,103) ) = (CONVERT(DATE,@Date,103) )
                    AND IsActive = 1
                  )
    END

    SELECT
    @ParentMeetingId=ParentMeetingId
    FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
    WHERE MeetingId = @Id AND IsActive = 1
    
	--Meeting Details
	SELECT
	 MD.MeetingId 
    ,MD.MeetingTypeId
    ,MType.TypeName AS MeetingType --Meeting TypeName
    ,MD.MeetingTitleId
    ,MD.MeetingTitle
    --,MTitle.MeetingTitle --Meeting Title
    ,MD.TeamsId 
    ,MD.ChannelId 
    ,MD.ChannelName
    ,MD.LocationId 
    ,MD.LocationName 
    ,MD.MeetingDescription 
    ,MD.CreatedBy
    ,MD.CreatedOn 
    ,MD.CreatedByEmail 
    ,MD.CreatedByADID 
    ,MD.UpdatedBy 
    ,MD.UpdatedOn 
    ,MD.UpdatedByEmail 
    ,MD.UpdatedByADID 
    ,MD.DivisionId 
    ,MD.DivisionName 
    ,MD.VerticalId 
    ,MD.VerticalName 
    ,MD.TimeZone 
    ,MD.StartDateTime 
    ,MD.EndDateTime
    ,MD.StartDateTimeUTC 
    ,MD.EndDateTimeUTC 
    ,MD.AllDayEvent 
    ,MD.RepeatOption 
    ,MD.AnchorName 
    ,MD.AnchorEmail 
    ,MD.AnchorADID
    ,MD.AnchorDivisionId
    ,MD.AnchorDivisionName
    ,MD.AnchorVerticalId
    ,MD.AnchorVerticalName
    ,MD.OrganiserName 
    ,MD.OrganiserEmail 
    ,MD.OrganiserADID
    ,MD.ICalUId
    ,MD.EventId 
    ,MD.JoinUrl 
    ,MD.SeriesMasterId
    ,MD.ChatId
    ,MD.EventType
    ,MD.ParentMeetingId
    ,MD.MeetingStatus
    ,MD.CreatedBy
    ,MD.CreatedByEmail
    ,MD.CreatedByADID
    ,MD.CreatedOn
    ,MD.IsConducted
	FROM dbo.[Trn_MeetingDetails] MD WITH(NOLOCK)
	INNER JOIN dbo.[Mst_MeetingType] MType WITH(NOLOCK) ON MD.MeetingTypeId = MType.TypeId
	WHERE MD.MeetingId = @Id 
    AND MD.MeetingStatus != 'Cancelled'

    --Meeting Occurrence
    SELECT
     MRD.RepeatId
    ,MRD.MeetingId 
    ,MRD.Frequency 
    ,MRD.StartDate 
    ,MRD.RepeatEvery 
    ,MRD.OnADay 
    ,MRD.OnTheWeek 
    ,MRD.OnTheWeekDay 
    ,MRD.OnTheMonth 
    ,MRD.EndDate
    ,MRD.StartDateUTC
    ,MRD.EndDateUTC
    FROM dbo.[Trn_MeetingRepeatDetails] MRD WITH(NOLOCK)
    INNER JOIN dbo.[Trn_MeetingDetails] MD WITH(NOLOCK) ON MD.MeetingId = MRD.MeetingId
    WHERE 
    (
    MRD.MeetingId = @Id
    OR 
    MRD.MeetingId = ISNULL(@ParentMeetingId,ParentMeetingId)
    )
    AND MD.MeetingStatus != 'Cancelled'
    AND MRD.IsActive = 1
    --ORDER BY MRD.MeetingId, MRD.RepeatId

    --Meeting Participants
    SELECT
    MP.ParticipantId
    ,MP.MeetingId
    ,MP.ParticipantName
    ,MP.ParticipantEmail
    ,MP.ParticipantADID
    ,MP.ParticipantType
    ,MP.CreatedOn
    ,MP.UpdatedOn
    ,MP.Active
    FROM dbo.[Trn_MeetingParticipants] MP WITH(NOLOCK)
    WHERE MP.MeetingId = @Id
    AND MP.Active = 1
    --ORDER BY MP.MeetingId, ParticipantId


    --Meeting Files
    SELECT
    MFU.FileId
    ,MFU.MeetingId
    ,MFU.[FileName]
    ,MFU.FileUrl
    ,MFU.ContentType
    FROM dbo.[Trn_MeetingFileUpload] MFU WITH(NOLOCK)
    WHERE MFU.MeetingId = @Id
    AND MFU.IsActive = 1
    ORDER BY [FileName]

    --Meeting SPO Files
    SELECT
    RES.MeetingSPOFileName AS [FileName],
    RES.SPOWebUrl,
    RES.SPOItemId
    FROM dbo.[MeetingSPOFileUploadResponse] RES WITH(NOLOCK)
    WHERE RES.MeetingId = @Id
    AND RES.IsActive = 1

END
GO
PRINT N'Altering Procedure [dbo].[usp_MeetingDetails_GetAll]...';


GO
ALTER PROC [dbo].[usp_MeetingDetails_GetAll]
	@FromDate DATETIME = NULL,
	@ToDate DATETIME = NULL,
	@SysFromDate DATETIME = NULL, --FOR UPCOMING MEETINGS
	@SysToDate DATETIME = NULL, -- FOR PAST MEETINGS
	@MTypeId INT,
    @UserEmail VARCHAR(100)=NULL,
    @MeetingTitle NVARCHAR(500)=NULL,
    @OrganiserName NVARCHAR(100)=NULL
AS
BEGIN
	--Meeting Details
	SELECT
     MD.MeetingId 
    ,MD.MeetingTypeId
    ,MType.TypeName AS MeetingType --Meeting TypeName
    ,MD.MeetingTitleId
    ,MD.MeetingTitle
    --,MTitle.MeetingTitle --Meeting Title
    ,MD.TeamsId 
    ,MD.ChannelId 
    ,MD.ChannelName
    ,MD.LocationId 
    ,MD.LocationName 
    ,MD.MeetingDescription 
    ,MD.CreatedBy
    ,MD.CreatedOn 
    ,MD.CreatedByEmail 
    ,MD.CreatedByADID 
    ,MD.UpdatedBy 
    ,MD.UpdatedOn 
    ,MD.UpdatedByEmail 
    ,MD.UpdatedByADID 
    --,MD.DivisionId 
    ,MD.DivisionName 
    --,MD.VerticalId 
    ,MD.VerticalName 
    ,MD.TimeZone 
    ,MD.StartDateTime 
    ,MD.EndDateTime
    ,MD.StartDateTimeUTC 
    ,MD.EndDateTimeUTC 
    ,MD.AllDayEvent 
    ,MD.RepeatOption 
    ,MD.AnchorName 
    ,MD.AnchorEmail 
    ,MD.AnchorADID
    ,MD.OrganiserName 
    ,MD.OrganiserEmail 
    ,MD.OrganiserADID
    ,MD.ICalUId
    ,MD.EventId 
    ,MD.JoinUrl 
    ,MD.SeriesMasterId
    ,MD.ChatId
    ,MD.EventType
    ,MD.ParentMeetingId
    ,MD.MeetingStatus
	,IsConducted
	FROM dbo.[Trn_MeetingDetails] MD WITH(NOLOCK)
	INNER JOIN dbo.Mst_MeetingType MType WITH(NOLOCK) ON MD.MeetingTypeId = MType.TypeId
	WHERE
	--1. meeting type filter
	MD.MeetingTypeId = CASE WHEN ISNULL(@MTypeId ,0)=0 THEN MD.MeetingTypeId ELSE @MTypeId END
	--2. not cancelled meeting filter
    AND MD.MeetingStatus != 'Cancelled'
	--3. meeting start date filter
    AND (CONVERT(DATETIME,MD.StartDateTime,114) >= CONVERT(DATETIME,@FromDate,114) OR @FromDate IS NULL)
	--4. meeting end date filter
    AND (CONVERT(DATETIME,MD.StartDateTime,114) <= CONVERT(DATETIME,@ToDate,114)  OR @ToDate IS NULL)
	--5. login user filter
    AND  (MD.AnchorEmail = @UserEmail 
            OR MD.OrganiserEmail = @UserEmail 
            OR MD.CreatedByEmail = @UserEmail
            OR MeetingId IN (SELECT MeetingId FROM Trn_MeetingParticipants P WITH(NOLOCK) WHERE P.ParticipantEmail = @UserEmail and Active = 1))
	--6. meeting title filter
    AND MD.MeetingTitle LIKE ISNULL(@MeetingTitle,MD.MeetingTitle)+'%'
	--7. meeting organizer filter
    AND MD.OrganiserName LIKE ISNULL(@OrganiserName,MD.OrganiserName)+'%'
	--8. upcoming meeting filter
	AND (CONVERT(DATETIME,MD.EndDateTime,114) >= CONVERT(DATETIME,@SysFromDate,114) OR @SysFromDate IS NULL)
    --9. past meeting filter
	AND (CONVERT(DATETIME,MD.EndDateTime,114) < CONVERT(DATETIME,@SysToDate,114)  OR @SysToDate IS NULL)
    --10. active meeting filter
    AND MD.IsActive = 1    
	ORDER BY MD.StartDateTime,MD.EndDateTime,MD.CreatedOn DESC

END
GO
PRINT N'Altering Procedure [dbo].[usp_MeetingDetails_Insert]...';


GO
ALTER PROCEDURE [dbo].[usp_MeetingDetails_Insert] 
     @MeetingTypeId INT 
    ,@MeetingTitleId INT
    ,@MeetingTitle NVARCHAR(500)=NULL
    ,@TeamsId NVARCHAR(200)=NULL
    ,@ChannelId NVARCHAR(200)=NULL
    ,@ChannelName NVARCHAR(200)=NULL
    ,@LocationId NVARCHAR(100)=NULL
    ,@LocationName NVARCHAR(100)=NULL
    ,@MeetingDescription NTEXT
    ,@CreatedBy NVARCHAR(100)=NULL 
    ,@CreatedOn DATETIME=NULL 
    ,@CreatedByEmail NVARCHAR(100)=NULL 
    ,@CreatedByADID NVARCHAR(50)=NULL   
    ,@DivisionName NVARCHAR(100)=NULL
    ,@VerticalName NVARCHAR(100)=NULL
    ,@TimeZone NVARCHAR(200)=NULL
    ,@StartDateTime DATETIME
    ,@EndDateTime DATETIME
    --,@StartDateTimeUTC DATETIME=NULL
    --,@EndDateTimeUTC DATETIME=NULL
    ,@AllDayEvent BIT=0
    ,@RepeatOption NVARCHAR(100)
    ,@AnchorName NVARCHAR(100)=NULL
    ,@AnchorEmail NVARCHAR(100)=NULL
    ,@AnchorADID NVARCHAR(100)=NULL
    ,@AnchorDivisionName NVARCHAR(100)=NULL
    ,@AnchorVerticalName NVARCHAR(100)=NULL
    ,@ICalUId NVARCHAR(500)=NULL
    ,@EventId NVARCHAR(500)=NULL
    ,@JoinUrl NVARCHAR(500)=NULL
    ,@SeriesMasterId NVARCHAR(500)=NULL
    ,@ParentMeetingId BIGINT=NULL
    ,@OrganiserName NVARCHAR(100)=NULL 
    ,@OrganiserEmail NVARCHAR(100)=NULL 
    ,@OrganiserADID NVARCHAR(100)=NULL
    ,@ChatId NVARCHAR(500)=NULL
    ,@EventType NVARCHAR(500)=NULL

    ,@RepeatFrequency NVARCHAR(100)=NULL
    ,@RepeatStartDate DATETIME=NULL
    ,@RepeatEvery INT=NULL
    ,@RepeatOnADay INT=NULL
    ,@RepeatOnTheWeek NVARCHAR(20)=NULL
    ,@RepeatOnTheWeekDay NVARCHAR(100)=NULL
    ,@RepeatOnTheMonth NVARCHAR(20)=NULL
    ,@RepeatEndDate DATETIME=NULL
    
    
    ,@Participants UDT_MeetingParticipants READONLY
    ,@MeetingInstances UDT_MeetingInstances READONLY
AS
BEGIN

    DECLARE  @DivisionId INT
    DECLARE  @VerticalId INT
    DECLARE  @AnchorDivisionId INT
    DECLARE  @AnchorVerticalId INT
    DECLARE @StartDateTimeUTC DATETIME=NULL
    DECLARE @EndDateTimeUTC DATETIME=NULL
    DECLARE @RepeatStartDateTimeUTC DATETIME=NULL
    DECLARE @RepeatEndDateTimeUTC DATETIME=NULL
    DECLARE @MeetingIdList NVARCHAR(1000)=NULL

    BEGIN TRANSACTION

        SET @StartDateTimeUTC = (@StartDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')

        SET @EndDateTimeUTC = (@EndDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')

        -- GET ANCHOR DIVISION ID & VERTICAL ID
        IF EXISTS ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @AnchorDivisionName )
        BEGIN
            SET @AnchorDivisionId = ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @AnchorDivisionName )
        END

         IF EXISTS ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionName = @AnchorDivisionName AND V.VerticalName = @AnchorVerticalName )
        BEGIN
            SET @AnchorVerticalId = ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionId = V.DivisionId AND D.DivisionName = @AnchorDivisionName AND V.VerticalName = @AnchorVerticalName )
        END

        -- GET CREATED BY DIVISION ID & VERTICAL ID
        IF EXISTS ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @DivisionName )
        BEGIN
            SET @DivisionId = ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @DivisionName )
        END

         IF EXISTS ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionName = @DivisionName AND V.VerticalName = @VerticalName )
        BEGIN
            SET @VerticalId = ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionId = V.DivisionId AND D.DivisionName = @DivisionName AND V.VerticalName = @VerticalName )
        END

        INSERT INTO dbo.[Trn_MeetingDetails]
	    (
          MeetingTypeId
         ,MeetingTitleId
         ,MeetingTitle
         ,TeamsId
         ,ChannelId
         ,ChannelName
         ,LocationId
         ,LocationName
         ,MeetingDescription
         ,CreatedBy
         ,CreatedOn
         ,CreatedByEmail
         ,CreatedByADID
         ,DivisionId
         ,DivisionName
         ,VerticalId
         ,VerticalName
         ,TimeZone
         ,StartDateTime
         ,EndDateTime
         ,StartDateTimeUTC
         ,EndDateTimeUTC
         ,AllDayEvent
         ,RepeatOption
         ,AnchorName
         ,AnchorEmail
         ,AnchorADID
         ,AnchorDivisionId
         ,AnchorDivisionName
         ,AnchorVerticalId
         ,AnchorVerticalName
         ,ICalUId
         ,EventId
         ,JoinUrl
         ,SeriesMasterId
         ,MeetingStatus
         ,OrganiserName
         ,OrganiserEmail
         ,OrganiserADID
         ,ChatId
         ,EventType
         ,IsConducted
         ,IsActive
        )
        VALUES
        ( 
         @MeetingTypeId
        ,@MeetingTitleId
        ,@MeetingTitle
        ,@TeamsId
        ,@ChannelId
        ,@ChannelName
        ,@LocationId
        ,@LocationName 
        ,@MeetingDescription
        ,@CreatedBy
        ,GETUTCDATE()
        ,@CreatedByEmail
        ,@CreatedByADID
        ,@DivisionId 
        ,@DivisionName
        ,@VerticalId
        ,@VerticalName
        ,@TimeZone
        ,@StartDateTime
        ,@EndDateTime
        ,@StartDateTimeUTC
        ,@EndDateTimeUTC
        ,@AllDayEvent
        ,@RepeatOption
        ,@AnchorName
        ,@AnchorEmail
        ,@AnchorADID
        ,@AnchorDivisionId
        ,@AnchorDivisionName
        ,@AnchorVerticalId
        ,@AnchorVerticalName
        ,@ICalUId
        ,@EventId
        ,@JoinUrl
        ,@SeriesMasterId
        ,'Scheduled'
         ,@OrganiserName
         ,@OrganiserEmail
         ,@OrganiserADID
         ,@ChatId
         ,@EventType
         ,0
         ,1
        )

    ---
    DECLARE @MeetingId BIGINT=0


    SET @MeetingId=@@IDENTITY

    SET @MeetingIdList = @MeetingId
    ---

    IF @@ERROR<>0
	BEGIN
		ROLLBACK TRANSACTION
		SELECT 
			'Something went wrong, unable to save meeting details'	AS [Message],
			''						                                AS ErrorMessage,
			0						                                AS [Status],
			@MeetingId					                AS Id,
			''						                                AS ReferenceNo
		RETURN 
	END

    --Insert into MeetingRepeatDetails which are repeatable
    IF (ISNULL(@RepeatOption,'')!='' AND  @RepeatOption!='doesnotrepeat')
    BEGIN

        SET @RepeatStartDateTimeUTC = (@RepeatStartDate AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
        SET @RepeatEndDateTimeUTC = (@RepeatEndDate AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
        
        INSERT INTO dbo.[Trn_MeetingRepeatDetails]
	    (
		     MeetingId
            ,Frequency
            ,StartDate
            ,RepeatEvery
            ,OnADay
            ,OnTheWeek
            ,OnTheWeekDay
            ,OnTheMonth
            ,EndDate
            ,StartDateUTC
            ,EndDateUTC
            ,IsActive
	    )
        VALUES
        (
             @MeetingId
            ,@RepeatFrequency
            ,@RepeatStartDate
            ,@RepeatEvery
            ,@RepeatOnADay
            ,@RepeatOnTheWeek
            ,@RepeatOnTheWeekDay
            ,@RepeatOnTheMonth
            ,@RepeatEndDate
            ,@RepeatStartDateTimeUTC
            ,@RepeatEndDateTimeUTC
            ,1
        )
        

        IF @@ERROR<>0
	    BEGIN
		    ROLLBACK TRANSACTION
		    SELECT 
			    'Something went wrong, unable to add meeting occurrence'	AS [Message],
			    ''						            AS ErrorMessage,
			    0						            AS [Status],
			    @MeetingId			    AS Id,
			    ''						            AS ReferenceNo
		    RETURN 
	    END
    END

    --Insert into MeetingParticipants
    INSERT INTO dbo.[Trn_MeetingParticipants]
	(
		 MeetingId
        ,ParticipantType
        ,ParticipantName
        ,ParticipantEmail
        ,ParticipantADID
        ,CreatedOn
        ,Active
	)
    SELECT 
         @MeetingId
        ,ParticipantType
        ,ParticipantName
        ,ParticipantEmail
        ,ParticipantADID
        ,GETUTCDATE()
        ,1
    FROM @Participants

    IF @@ERROR<>0
	BEGIN
		ROLLBACK TRANSACTION
		SELECT 
			'Something went wrong, unable to add meeting participants'	AS [Message],
			''						        AS ErrorMessage,
			0						        AS [Status],
			@MeetingId		    AS Id,
			''						        AS ReferenceNo
		RETURN 
	END

    --If there is any instances
	IF EXISTS(SELECT 1 FROM @MeetingInstances)
	BEGIN
        INSERT INTO dbo.[Trn_MeetingDetails]
	    (
              MeetingTypeId
             ,MeetingTitleId
             ,MeetingTitle
             ,TeamsId
             ,ChannelId
             ,ChannelName
             ,LocationId
             ,LocationName
             ,MeetingDescription
             ,CreatedBy
             ,CreatedOn
             ,CreatedByEmail
             ,CreatedByADID
             ,DivisionId
             ,DivisionName
             ,VerticalId
             ,VerticalName
             ,TimeZone
             ,StartDateTime
             ,EndDateTime
             ,StartDateTimeUTC
             ,EndDateTimeUTC
             ,AllDayEvent
             ,RepeatOption
             ,AnchorName
             ,AnchorEmail
             ,AnchorADID
             ,AnchorDivisionId
             ,AnchorDivisionName
             ,AnchorVerticalId
             ,AnchorVerticalName
             ,ICalUId
             ,EventId
             ,JoinUrl
             ,SeriesMasterId
             ,MeetingStatus
             ,OrganiserName
             ,OrganiserEmail
             ,OrganiserADID
             ,ChatId
             ,EventType
             ,ParentMeetingId
             ,IsConducted
             ,IsActive
        )
        SELECT
             @MeetingTypeId
            ,@MeetingTitleId
            ,@MeetingTitle
            ,@TeamsId
            ,@ChannelId
            ,@ChannelName
            ,@LocationId
            ,@LocationName 
            ,@MeetingDescription
            ,@CreatedBy
            ,GETUTCDATE()
            ,@CreatedByEmail
            ,@CreatedByADID
            ,@DivisionId 
            ,@DivisionName
            ,@VerticalId
            ,@VerticalName
            ,@TimeZone
            ,MI.StartDateTime
            ,MI.EndDateTime
            --,@StartDateTimeUTC
            ,(MI.StartDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
            --,@EndDateTimeUTC
            ,(MI.EndDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
            ,@AllDayEvent
            ,@RepeatOption
            ,@AnchorName
            ,@AnchorEmail
            ,@AnchorADID
            ,@AnchorDivisionId
            ,@AnchorDivisionName
            ,@AnchorVerticalId
            ,@AnchorVerticalName
            ,MI.ICalUId
            ,MI.EventId
            ,MI.JoinUrl
            ,MI.SeriesMasterId
            ,'Scheduled'
            ,@OrganiserName
            ,@OrganiserEmail
            ,@OrganiserADID
            ,MI.ChatId
            ,MI.EventType
            ,@MeetingId
            ,0
            ,1
        FROM @MeetingInstances MI

        IF @@ERROR<>0
        BEGIN
            ROLLBACK TRANSACTION
            SELECT 
	            'Something went wrong, unable to create recurrence meeting'	AS [Message],
	            ''						                                    AS ErrorMessage,
	            0						                                    AS [Status],
	            @MeetingId			                            AS Id,
	            ''						                                    AS ReferenceNo
            RETURN 
        END

        --Insert into MeetingParticipants for recurrence meeting
        INSERT INTO dbo.[Trn_MeetingParticipants]
	    (
		     MeetingId
            ,ParticipantType
            ,ParticipantName
            ,ParticipantEmail
            ,ParticipantADID
            ,CreatedOn
            ,Active
	    )
        SELECT 
             MD.MeetingId
            ,ParticipantType
            ,ParticipantName
            ,ParticipantEmail
            ,ParticipantADID
            ,GETUTCDATE()
            ,1
        FROM dbo.[Trn_MeetingDetails] MD WITH(NOLOCK)
        INNER JOIN dbo.[Trn_MeetingParticipants] MP WITH(NOLOCK) ON MD.ParentMeetingId=MP.MeetingId
		WHERE MD.ParentMeetingId=@MeetingId
        AND MD.IsActive = 1
		ORDER BY MD.MeetingId

        IF @@ERROR<>0
	    BEGIN
		    ROLLBACK TRANSACTION
		    SELECT 
			    'Something went wrong, unable to add meeting participants for recurrence meeting'   AS [Message],
			    ''						AS ErrorMessage,
			    0						AS [Status],
			    @MeetingId			    AS Id,
			    ''						AS ReferenceNo
		    RETURN 
	    END

    END

    IF EXISTS(SELECT 1 FROM @MeetingInstances)
    BEGIN
        ;WITH DATA1 AS 
        (
        SELECT MeetingId
        FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
        WHERE ParentMeetingId = @MeetingId
        )
        SELECT @MeetingIdList = CONCAT(@MeetingIdList,',',MeetingId)
        FROM DATA1
    END

    COMMIT TRANSACTION
	SELECT 
		'Meeting details saved successfully'        AS	[Message],
		''								            AS ErrorMessage,
		1								            AS [Status],
		@MeetingId					                AS Id,
	    @MeetingIdList					            AS ReferenceNo
END
GO
PRINT N'Altering Procedure [dbo].[usp_MeetingDetails_Update]...';


GO
 ALTER PROCEDURE [dbo].[usp_MeetingDetails_Update]
    @MeetingId BIGINT=NULL
    ,@MeetingTypeId INT=NULL
    ,@MeetingTitleId INT=NULL
    ,@MeetingTitle NVARCHAR(500)=NULL
     ,@TeamsId NVARCHAR(200)=NULL
    ,@ChannelId NVARCHAR(200)=NULL
    ,@ChannelName NVARCHAR(200)=NULL
    ,@LocationId NVARCHAR(100)=NULL
    ,@LocationName NVARCHAR(100)=NULL
    ,@MeetingDescription NTEXT=NULL
    ,@UpdatedBy NVARCHAR(100)=NULL  
    ,@UpdatedByEmail NVARCHAR(100)=NULL 
    ,@UpdatedByADID NVARCHAR(50)=NULL   
    ,@DivisionName NVARCHAR(100)=NULL
    ,@VerticalName NVARCHAR(100)=NULL
    ,@TimeZone NVARCHAR(200)=NULL
    ,@StartDateTime DATETIME=NULL
    ,@EndDateTime DATETIME=NULL
    --,@StartDateTimeUTC DATETIME=NULL
    --,@EndDateTimeUTC DATETIME=NULL
    ,@AllDayEvent BIT=0
    ,@RepeatOption NVARCHAR(100)=NULL
    ,@AnchorName NVARCHAR(100)=NULL 
    ,@AnchorEmail NVARCHAR(100)=NULL 
    ,@AnchorADID NVARCHAR(100)=NULL
    ,@AnchorDivisionName NVARCHAR(100)=NULL
    ,@AnchorVerticalName NVARCHAR(100)=NULL
    ,@CreatedBy NVARCHAR(100)=NULL
    ,@CreatedByEmail NVARCHAR(100)=NULL
    ,@CreatedByADID NVARCHAR(100)=NULL
    ,@CreatedOn DATETIME=NULL
    ,@ICalUId NVARCHAR(500)=NULL
    ,@EventId NVARCHAR(500)=NULL
    ,@JoinUrl NVARCHAR(500)=NULL
    ,@SeriesMasterId NVARCHAR(500)=NULL
    ,@OrganiserName NVARCHAR(100)=NULL 
    ,@OrganiserEmail NVARCHAR(100)=NULL 
    ,@OrganiserADID NVARCHAR(100)=NULL
    ,@ChatId NVARCHAR(500)=NULL
    ,@EventType NVARCHAR(500)=NULL
    ,@ParentMeetingId BIGINT=NULL

    ,@CancelRemark NVARCHAR(200) = NULL

    ,@RepeatId INT = 0
    ,@RepeatFrequency NVARCHAR(100)=NULL
    ,@RepeatStartDate DATETIME=NULL
    ,@RepeatEvery INT=NULL
    ,@RepeatOnADay INT=NULL
    ,@RepeatOnTheWeek NVARCHAR(20)=NULL
    ,@RepeatOnTheWeekDay NVARCHAR(100)=NULL
    ,@RepeatOnTheMonth NVARCHAR(20)=NULL
    ,@RepeatEndDate DATETIME=NULL
    
    
    ,@Participants UDT_MeetingParticipants READONLY
    ,@MeetingInstances UDT_MeetingInstances READONLY

    ,@Remark NVARCHAR(20)
    ,@IsSeriesUpdate BIT = 0
AS
BEGIN

    DECLARE  @DivisionId INT=NULL
    DECLARE  @VerticalId INT=NULL
    DECLARE  @AnchorDivisionId INT
    DECLARE  @AnchorVerticalId INT
    DECLARE @StartDateTimeUTC DATETIME=NULL
    DECLARE @EndDateTimeUTC DATETIME=NULL
    DECLARE @RepeatStartDateTimeUTC DATETIME=NULL
    DECLARE @RepeatEndDateTimeUTC DATETIME=NULL

    BEGIN TRANSACTION

        SET @StartDateTimeUTC = (@StartDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')

        SET @EndDateTimeUTC = (@EndDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')        
        
        --BEGIN CANCEL MEETING

        -- IF SINGLE EVENT
        IF(@Remark = 'cancelled' AND @EventId IS NOT NULL)
        BEGIN
				SELECT 
				@SeriesMasterId=SeriesMasterId
				,@EventType=EventType
				,@TimeZone=TimeZone
				FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
				WHERE EventId=@EventId

                -- UPDATE PARENT-MEETING ID
                IF ( (@ParentMeetingId=0) AND @EventType != 'SingleInstance' )
                BEGIN
				
					DECLARE @NEWPARENTMEETINGID BIGINT = ( SELECT MIN(MeetingId) FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK) WHERE SeriesMasterId=@SeriesMasterId AND IsActive=1 AND MeetingId > @MeetingId )
                    
					UPDATE dbo.[Trn_MeetingDetails]
                    SET ParentMeetingId = @NEWPARENTMEETINGID
                    WHERE ParentMeetingId = @MeetingId

					UPDATE dbo.[Trn_MeetingDetails]
                    SET ParentMeetingId = NULL
                    WHERE MeetingId = @NEWPARENTMEETINGID

					-- UPDATE MEETING ID IN MEETING REPEAT DETAILS
					UPDATE dbo.[Trn_MeetingRepeatDetails]
					SET MeetingId=@NEWPARENTMEETINGID
					WHERE MeetingId = @MeetingId

					SET @ParentMeetingId=@NEWPARENTMEETINGID

                END

                -- CANCEL EVENT
                UPDATE dbo.[Trn_MeetingDetails]
                SET MeetingStatus='Cancelled'
                ,IsActive=0
                ,CancelRemark=@CancelRemark
                ,UpdatedBy=@UpdatedBy
                ,UpdatedOn=GETUTCDATE()
                ,UpdatedByEmail=@UpdatedByEmail
                ,UpdatedByADID=@UpdatedByADID
                WHERE MeetingId=@MeetingId
                
                SELECT 
		        'Meeting cancelled successfully'            AS	[Message],
		        ''								            AS ErrorMessage,
		        1								            AS [Status],
		        @MeetingId					                AS Id,
	            ''					                        AS ReferenceNo
                IF @@ERROR<>0
	            BEGIN
		            ROLLBACK TRANSACTION
		            SELECT 
			            'Something went wrong, unable to cancel meeting'      AS [Message],
			            ''						                              AS ErrorMessage,
			            0						                              AS [Status],
			            @MeetingId					                          AS Id,
			            ''						                              AS ReferenceNo
		            RETURN 
	            END

                 -- DELETE FROM PARTICIPANTS
                DELETE FROM dbo.[Trn_MeetingParticipants] 
                WHERE MeetingId  = @MeetingId;
                IF @@ERROR<>0
                BEGIN
	                ROLLBACK TRANSACTION
	                SELECT 
		                'Something went wrong, unable to delete meeting participants'	AS [Message],
		                ''						AS ErrorMessage,
		                0						AS [Status],
		                @MeetingId			    AS Id,
		                ''						AS ReferenceNo
	                RETURN 
                END              

                -- UPDATE MEETING REPEAT DETAILS TABLE
                IF EXISTS (SELECT TOP 1 MeetingId FROM dbo.[Trn_MeetingRepeatDetails] WITH(NOLOCK) WHERE (MeetingId = @MeetingId OR MeetingId=@ParentMeetingId))
                BEGIN

                    --SET @SeriesMasterId = (SELECT SeriesMasterId FROM dbo.[Trn_MeetingDetails] WHERE EventId=@EventId);

                    DECLARE @MAXMEETINGID BIGINT=0;
                    DECLARE @MINMEETINGID BIGINT=0;

					SELECT 
					@MINMEETINGID=MIN(MeetingId)
					,@MAXMEETINGID=MAX(MeetingId)
					FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
					WHERE SeriesMasterId=@SeriesMasterId AND IsActive=1

					SELECT 
					@RepeatStartDate=CONVERT(DATE,StartDate)
					,@RepeatEndDate=CONVERT(DATE,EndDate)
					FROM dbo.[Trn_MeetingRepeatDetails] WITH(NOLOCK)
					WHERE MeetingId = @MeetingId OR MeetingId=@ParentMeetingId
					
					DECLARE @MinStartDateTime DATETIME = NULL;
					DECLARE @MinStartDateTimeUTC DATETIME = NULL;
					SELECT @MinStartDateTime=CONVERT(DATE,StartDateTime),@MinStartDateTimeUTC=CONVERT(DATE,StartDateTimeUTC) FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK) WHERE MeetingId = @MINMEETINGID

					DECLARE @MaxEndDateTime DATETIME = NULL;
					DECLARE @MaxEndDateTimeUTC DATETIME = NULL;
					SELECT @MaxEndDateTime=CONVERT(DATE,EndDateTime),@MaxEndDateTimeUTC=CONVERT(DATE,EndDateTimeUTC) FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK) WHERE MeetingId = @MAXMEETINGID

                   IF ( @RepeatStartDate != @MinStartDateTime )
                   BEGIN
                    UPDATE dbo.[Trn_MeetingRepeatDetails]
                    SET StartDate = @MinStartDateTime
					,StartDateUTC = @MinStartDateTimeUTC
					WHERE (MeetingId = @MeetingId OR MeetingId=@ParentMeetingId)
                   END

                   IF ( @RepeatStartDate != @MaxEndDateTime )
                   BEGIN
                    UPDATE dbo.[Trn_MeetingRepeatDetails]
                    SET EndDate = @MaxEndDateTime
					,EndDateUTC =  @MaxEndDateTimeUTC
					WHERE (MeetingId = @MeetingId OR MeetingId=@ParentMeetingId)
                   END
               END

			   SET @SeriesMasterId = NULL
           END

            -- IF SERIES EVENT
            IF(@Remark = 'cancelled' AND @SeriesMasterId IS NOT NULL)
            BEGIN

                UPDATE dbo.[Trn_MeetingDetails]
                SET MeetingStatus='Cancelled'
                ,IsActive=0
                ,CancelRemark=@CancelRemark
                ,UpdatedBy=@UpdatedBy
                ,UpdatedOn=GETUTCDATE()
                ,UpdatedByEmail=@UpdatedByEmail
                ,UpdatedByADID=@UpdatedByADID
                WHERE 
                (
                MeetingId=@MeetingId
                OR ParentMeetingId=@ParentMeetingId
                OR MeetingId = @ParentMeetingId
                OR ParentMeetingId = @MeetingId
                )
                AND IsActive = 1
                IF @@ERROR<>0
	            BEGIN
		            ROLLBACK TRANSACTION
		            SELECT 
			            'Something went wrong, unable to cancel meeting'      AS [Message],
			            ''						                              AS ErrorMessage,
			            0						                              AS [Status],
			            @ParentMeetingId				    AS Id,
			            ''						                              AS ReferenceNo

		            RETURN 
	            END


                SELECT 
		        'Meeting cancelled successfully'            AS	[Message],
		        ''								                                         AS ErrorMessage,
		        1								                                         AS [Status],
		        @ParentMeetingId					                 AS Id,
	            ''					                                                     AS ReferenceNo
                IF @@ERROR<>0
	            BEGIN
		            ROLLBACK TRANSACTION
		            SELECT 
			            'Something went wrong, unable to cancel meeting'      AS [Message],
			            ''						                              AS ErrorMessage,
			            0						                              AS [Status],
			            @MeetingId					              AS Id,
			            ''						                              AS ReferenceNo

		            RETURN 
	            END

                 -- DELETE FROM PARTICIPANTS
                DELETE FROM dbo.[Trn_MeetingParticipants] 
                WHERE MeetingId IN 
                ( 
                    SELECT MeetingId 
                    FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
                    WHERE 
                    (
                        MeetingId=@MeetingId
                        OR ParentMeetingId=@ParentMeetingId
                        OR MeetingId = @ParentMeetingId
                        OR ParentMeetingId = @MeetingId
                    )
                    AND IsActive = 1
                )
                IF @@ERROR<>0
                BEGIN
	                ROLLBACK TRANSACTION
	                SELECT 
		                'Something went wrong, unable to delete meeting participants'	AS [Message],
		                ''						    AS ErrorMessage,
		                0						    AS [Status],
		                @MeetingId		AS Id,
		                ''						    AS ReferenceNo
	                RETURN 
                END

				-- UPDATE MEETING REPEAT DETAILS
                UPDATE dbo.[Trn_MeetingRepeatDetails]
				SET IsActive=0
                WHERE MeetingId = @MeetingId OR MeetingId = @ParentMeetingId
                IF @@ERROR<>0
                BEGIN
	                ROLLBACK TRANSACTION
	                SELECT 
		                'Something went wrong, unable to update meeting repeat details'	AS [Message],
		                ''																AS ErrorMessage,
		                0																AS [Status],
		                @MeetingId														AS Id,
		                ''																AS ReferenceNo
	                RETURN 
                END
                
           END

           -- END CANCEL MEETING


           -- BEGIN UPDATE MEETING
           IF(@Remark = 'Updated')
           BEGIN

           UPDATE dbo.[Trn_MeetingDetails]
                SET TeamsId=ISNULL(@TeamsId,TeamsId)
                ,ChannelId=ISNULL(@ChannelId,ChannelId)
                ,ChannelName=ISNULL(@ChannelName,ChannelName)
                ,LocationId=ISNULL(@LocationId,LocationId)
                ,LocationName=ISNULL(@LocationName,LocationName)
                ,MeetingDescription=ISNULL(@MeetingDescription,MeetingDescription)
                ,UpdatedBy=@UpdatedBy
                ,UpdatedOn=GETUTCDATE()
                ,UpdatedByEmail=@UpdatedByEmail
                ,UpdatedByADID=@UpdatedByADID
                --,DivisionName=ISNULL(@DivisionName,DivisionName)
                --,VerticalName=ISNULL(@VerticalName,VerticalName)
                ,TimeZone=ISNULL(@TimeZone,TimeZone)
                ,StartDateTime=@StartDateTime
                ,EndDateTime=@EndDateTime
                ,StartDateTimeUTC = @StartDateTimeUTC
                ,EndDateTimeUTC = @EndDateTimeUTC
                ,AllDayEvent=ISNULL(@AllDayEvent,AllDayEvent)
                ,RepeatOption=ISNULL(@RepeatOption,RepeatOption)
                ,AnchorName=ISNULL(@AnchorName,AnchorName)
                ,AnchorEmail=ISNULL(@AnchorEmail,AnchorEmail)
                ,AnchorADID=ISNULL(@AnchorADID,AnchorADID)
                ,ICalUId=ISNULL(@ICalUId,ICalUId)
                ,EventId=@EventId
                ,JoinUrl=ISNULL(@JoinUrl,JoinUrl)
                ,SeriesMasterId=ISNULL(@SeriesMasterId,SeriesMasterId)
                ,OrganiserName=ISNULL(@OrganiserName,OrganiserName)
                ,OrganiserEmail=ISNULL(@OrganiserEmail,OrganiserEmail)
                ,OrganiserADID=ISNULL(@OrganiserADID,OrganiserADID)
                ,ChatId=ISNULL(@ChatId,ChatId)
                ,EventType=ISNULL(@EventType,EventType)
                ,IsConducted=ISNULL(IsConducted,0)
                ,IsActive = 1                
                WHERE MeetingId=@MeetingId

                IF(@MeetingTitleId=0)
                BEGIN
                    UPDATE dbo.[Trn_MeetingDetails]
                    SET MeetingTitle = ISNULL(@MeetingTitle,MeetingTitle)
                    WHERE MeetingId=@MeetingId
                END

                IF @@ERROR<>0
		        BEGIN
			        ROLLBACK TRANSACTION
			        SELECT 
				        'Something went wrong, unable to update meeting'	AS [Message],
				        ''						                            AS ErrorMessage,
				        0						                            AS [Status],
				        @MeetingId						        AS Id,
				        ''						                            AS ReferenceNo
			        RETURN 
	            END


            -- UPDATE INACTIVE PARTICIPANTS
            UPDATE dbo.[Trn_MeetingParticipants]
            SET Active=0
            ,UpdatedOn=GETUTCDATE()
            FROM dbo.[Trn_MeetingParticipants] MP WITH(NOLOCK)
            WHERE MP.MeetingId = @MeetingId
            AND
            (
                MP.ParticipantADID NOT IN
                (
                    SELECT ParticipantADID
                    FROM @Participants
                )
                OR MP.ParticipantEmail NOT IN
                (
                    SELECT ParticipantEmail
                    FROM @Participants
                )
            )
            IF @@ERROR<>0
		    BEGIN
		        ROLLBACK TRANSACTION
			    SELECT 
			        'Something went wrong, unable to remove meeting participants'   AS [Message],
				    ''						                                        AS ErrorMessage,
				    0						                                        AS [Status],
				    @MeetingId						                                AS Id,
				    ''						                                        AS ReferenceNo
			    RETURN 
	        END

            --DELETE INACTIVE PARTICIPANTS
            DELETE FROM dbo.[Trn_MeetingParticipants] 
                WHERE Active  = 0;
                IF @@ERROR<>0
	                BEGIN
		                ROLLBACK TRANSACTION
		                SELECT 
			                'Something went wrong, unable to delete inactive participants from meeting' AS [Message],
			                ''						AS ErrorMessage,
			                0						AS [Status],
			                @MeetingId			    AS Id,
			                ''						AS ReferenceNo
		                RETURN 
	                END

            -- UPDATE ACTIVE PARTICIPANTS
            UPDATE dbo.[Trn_MeetingParticipants]
            SET ParticipantType=X.ParticipantType
	            ,ParticipantName=X.ParticipantName
	            ,ParticipantEmail=X.ParticipantEmail
	            ,ParticipantADID=X.ParticipantADID
                ,UpdatedOn=GETUTCDATE()
                ,Active=1
            FROM dbo.[Trn_MeetingParticipants] MP WITH(NOLOCK),
                @Participants X
            WHERE MP.MeetingId = @MeetingId
            AND
            (
            MP.ParticipantADID = X.ParticipantADID
            OR 
            MP.ParticipantEmail = X.ParticipantEmail
            )
            AND MP.Active = 1

            IF @@ERROR<>0
	        BEGIN
		        ROLLBACK TRANSACTION
		        SELECT 
			        'Something went wrong, unable to update meeting participants'	AS [Message],
			        ''						                                    AS ErrorMessage,
			        0						                                    AS [Status],
			        @MeetingId			                                        AS Id,
			        ''						                                    AS ReferenceNo
		        RETURN 
	        END

            IF(@IsSeriesUpdate = 1)
            BEGIN

            SET @RepeatStartDateTimeUTC = (@RepeatStartDate AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
            SET @RepeatEndDateTimeUTC = (@RepeatEndDate AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')

            -- UPDATE MEETING REPEAT DETAILS
            UPDATE dbo.[Trn_MeetingRepeatDetails]
	            SET Frequency=@RepeatFrequency,
	            StartDate=@RepeatStartDate,
	            RepeatEvery=@RepeatEvery,
	            OnADay=@RepeatOnADay,
	            OnTheWeek=@RepeatOnTheWeek,
	            OnTheWeekDay=@RepeatOnTheWeekDay,
	            OnTheMonth=@RepeatOnTheMonth,
	            EndDate=@RepeatEndDate,
                StartDateUTC=@RepeatStartDateTimeUTC,
                EndDateUTC=@RepeatEndDateTimeUTC,
                IsActive=1
	            WHERE RepeatId=@RepeatId
                AND IsActive = 1
                AND @RepeatId > 0
	            IF @@ERROR<>0
	            BEGIN
		            SELECT 
			            'Something went wrong, unable to update meeting occurrence'	AS [Message],
			            ''															AS ErrorMessage,
			            0															AS [Status],
			            0															AS Id,
			            ''															AS ReferenceNo
		            RETURN 
	            END

                -- DELETE FROM PARTICIPANTS
                DELETE FROM dbo.[Trn_MeetingParticipants] 
                WHERE MeetingId IN ( SELECT MeetingId FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK) WHERE ParentMeetingId = @MeetingId AND IsActive=1);
                IF @@ERROR<>0
	                BEGIN
		                ROLLBACK TRANSACTION
		                SELECT 
			                'Something went wrong, unable to delete meeting participants'	AS [Message],
			                ''						    AS ErrorMessage,
			                0						    AS [Status],
			                @MeetingId		AS Id,
			                ''						    AS ReferenceNo
		                RETURN 
	                END
                 
                 -- IF MONTHLY MEETING
                 IF (@RepeatOption = 'AbsoluteMonthly' OR @RepeatOption = 'RelativeMonthly' OR @RepeatOption = 'AbsoluteYearly' OR @RepeatOption = 'RelativeYearly')
                 BEGIN
                    -- CREATE TEMP TABLE
                    DECLARE  @MeetingDetailsOld TABLE
	                (
	                    AutoId BIGINT IDENTITY(1,1),
	                    MeetingId BIGINT,
	                    ParentMeetingId BIGINT
	                )
                    -- SAVE MEETING DETAILS IN A TEMP TABLE
                    INSERT INTO @MeetingDetailsOld
                    (
                        MeetingId
                        ,ParentMeetingId
                    )
                    SELECT 
                        MeetingId
                        ,ParentMeetingId
                    FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
                    WHERE
                    (
                        MeetingId = @MeetingId
                        OR
                        ParentMeetingId = @MeetingId
                    )
                    AND IsActive=1
                 END
                 

                 -- INACTIVE MEETINGS FROM MEETING DETAILS
                 UPDATE dbo.[Trn_MeetingDetails]
                 SET IsActive = 0
                WHERE ParentMeetingId = @MeetingId;
                IF @@ERROR<>0
	                BEGIN
		                ROLLBACK TRANSACTION
		                SELECT 
			                'Something went wrong, unable to delete meeting occurrence'	AS [Message],
			                ''						AS ErrorMessage,
			                0						AS [Status],
			                @MeetingId			    AS Id,
			                ''						AS ReferenceNo
		                RETURN 
	                END
            END


            --INSERT INTO MEETING REPEAT DETAILS, IF THERE IS ANY NEW, I.E., REPEAT ID=0
            IF (@RepeatId=0 AND (ISNULL(@RepeatOption,'')!='' AND  @RepeatOption!='doesnotrepeat'))
            BEGIN

                SET @RepeatStartDateTimeUTC = (@RepeatStartDate AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
                SET @RepeatEndDateTimeUTC = (@RepeatEndDate AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')

                INSERT INTO dbo.[Trn_MeetingRepeatDetails]
	            (
		             MeetingId
                    ,Frequency
                    ,StartDate
                    ,RepeatEvery
                    ,OnADay
                    ,OnTheWeek
                    ,OnTheWeekDay
                    ,OnTheMonth
                    ,EndDate
                    ,StartDateUTC
                    ,EndDateUTC
                    ,IsActive
	            )
                VALUES
                (
                     @MeetingId
                    ,@RepeatFrequency
                    ,@RepeatStartDate
                    ,@RepeatEvery
                    ,@RepeatOnADay
                    ,@RepeatOnTheWeek
                    ,@RepeatOnTheWeekDay
                    ,@RepeatOnTheMonth
                    ,@RepeatEndDate
                    ,@RepeatStartDateTimeUTC
                    ,@RepeatEndDateTimeUTC
                    ,1
                )
                IF @@ERROR<>0
	            BEGIN
		            ROLLBACK TRANSACTION
		            SELECT 
			            'Something went wrong, unable to add meeting occurrence'	AS [Message],
			            ''						AS ErrorMessage,
			            0						AS [Status],
			            @MeetingId			    AS Id,
			            ''						AS ReferenceNo
		            RETURN 
	            END
            END

            --INSERT INTO MEETING PARTICIPANTS, IF THERE IS ANY NEW, I.E., PARTICIPANT ID=0 IN UDT
            INSERT INTO dbo.[Trn_MeetingParticipants]
	        (
		         MeetingId
                ,ParticipantType
                ,ParticipantName
                ,ParticipantEmail
                ,ParticipantADID
                ,Active
                ,CreatedOn
	        )
            SELECT 
                 @MeetingId
                 ,ParticipantType
                 ,ParticipantName
                 ,ParticipantEmail
                 ,ParticipantADID
                 ,1
                 ,GETUTCDATE()
            FROM @Participants P
            WHERE P.ParticipantId=0
            AND 
            (
            P.ParticipantADID NOT IN
            (
                SELECT ParticipantADID FROM dbo.[Trn_MeetingParticipants] WITH(NOLOCK) WHERE MeetingId=@MeetingId
            )
            OR
             P.ParticipantEmail NOT IN
            (
                SELECT ParticipantEmail FROM dbo.[Trn_MeetingParticipants] WITH(NOLOCK) WHERE MeetingId=@MeetingId
            )
            )

            IF @@ERROR<>0
	        BEGIN
		        ROLLBACK TRANSACTION
		        SELECT 
			        'Something went wrong, unable to add meeting participants'	AS [Message],
			        ''						                                    AS ErrorMessage,
			        0						                                    AS [Status],
			        @MeetingId			                            AS Id,
			        ''						                                    AS ReferenceNo
		        RETURN 
	        END

            --INSERT INTO MEETING PARTICIPANTS, IF THERE IS ANY OTHER PARTICIPANTS IN UDT
             INSERT INTO dbo.[Trn_MeetingParticipants]
	        (
		         MeetingId
                ,ParticipantType
                ,ParticipantName
                ,ParticipantEmail
                ,ParticipantADID
                ,Active
                ,CreatedOn
	        )
            SELECT 
                 @MeetingId
                 ,ParticipantType
                 ,ParticipantName
                 ,ParticipantEmail
                 ,ParticipantADID
                 ,1
                 ,GETUTCDATE()
            FROM @Participants P
            WHERE P.ParticipantADID NOT IN ( SELECT ParticipantADID FROM Trn_MeetingParticipants WITH(NOLOCK) WHERE MeetingId = @MeetingId AND Active = 1 )
            OR P.ParticipantEmail NOT IN ( SELECT ParticipantEmail FROM Trn_MeetingParticipants WITH(NOLOCK) WHERE MeetingId = @MeetingId AND Active = 1 )

            -- INSERT INTO MEETING DETAILS, IF THERE IS ANY NEW INSTANCES
            IF EXISTS(SELECT 1 FROM @MeetingInstances)
	        BEGIN


            -- GET ANCHOR DIVISION ID & VERTICAL ID
            IF EXISTS ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @AnchorDivisionName )
            BEGIN
                SET @AnchorDivisionId = ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @AnchorDivisionName )
            END

             IF EXISTS ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionName = @AnchorDivisionName AND V.VerticalName = @AnchorVerticalName )
            BEGIN
                SET @AnchorVerticalId = ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionId = V.DivisionId AND D.DivisionName = @AnchorDivisionName AND V.VerticalName = @AnchorVerticalName )
            END

            -- GET CREATED BY DIVISION ID & VERTICAL ID
            IF EXISTS ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @DivisionName )
                BEGIN
                    SET @DivisionId = ( SELECT DivisionId FROM dbo.[Mst_Division] WITH(NOLOCK) WHERE DivisionName = @DivisionName )
                END

            IF EXISTS ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionName = @DivisionName AND V.VerticalName = @VerticalName )
                BEGIN
                    SET @VerticalId = ( SELECT V.VerticalId FROM dbo.[Mst_Vertical] V WITH(NOLOCK), dbo.[Mst_Division] D WITH(NOLOCK) WHERE D.DivisionId = V.DivisionId AND D.DivisionName = @DivisionName AND V.VerticalName = @VerticalName )
                END

            INSERT INTO dbo.[Trn_MeetingDetails]
	        (
                  MeetingTypeId
                 ,MeetingTitleId
                 ,MeetingTitle
                 ,TeamsId
                 ,ChannelId
                 ,ChannelName
                 ,LocationId
                 ,LocationName
                 ,MeetingDescription
                 ,CreatedBy
                 ,CreatedOn
                 ,CreatedByEmail
                 ,CreatedByADID
                 ,UpdatedBy
                 ,UpdatedOn
                 ,UpdatedByEmail
                 ,UpdatedByADID
                 ,DivisionId
                 ,DivisionName
                 ,VerticalId
                 ,VerticalName
                 ,TimeZone
                 ,StartDateTime
                 ,EndDateTime
                 ,StartDateTimeUTC
                 ,EndDateTimeUTC
                 ,AllDayEvent
                 ,RepeatOption
                 ,AnchorName
                 ,AnchorEmail
                 ,AnchorADID
                 ,ICalUId
                 ,EventId
                 ,JoinUrl
                 ,SeriesMasterId
                 ,MeetingStatus
                 ,OrganiserName
                 ,OrganiserEmail
                 ,OrganiserADID
                 ,ChatId
                 ,EventType
                 ,ParentMeetingId
                 ,IsConducted
                 ,IsActive
            )
            SELECT
                 @MeetingTypeId
                ,@MeetingTitleId
                ,@MeetingTitle
                ,@TeamsId
                ,@ChannelId
                ,@ChannelName
                ,@LocationId
                ,@LocationName 
                ,@MeetingDescription
                ,@CreatedBy
                ,@CreatedOn
                ,@CreatedByEmail
                ,@CreatedByADID
                ,@UpdatedBy
                ,GETUTCDATE()
                ,@UpdatedByEmail
                ,@UpdatedByADID
                ,@DivisionId 
                ,@DivisionName
                ,@VerticalId
                ,@VerticalName
                ,@TimeZone
                ,MI.StartDateTime
                ,MI.EndDateTime
                --,@StartDateTimeUTC
                ,(MI.StartDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
                --,@EndDateTimeUTC
                ,(MI.EndDateTime AT TIME ZONE @TimeZone AT TIME ZONE 'UTC')
                ,@AllDayEvent
                ,@RepeatOption
                ,@AnchorName
                ,@AnchorEmail
                ,@AnchorADID
                ,MI.ICalUId
                ,MI.EventId
                ,MI.JoinUrl
                ,MI.SeriesMasterId
                ,'Scheduled'
                ,@OrganiserName
                ,@OrganiserEmail
                ,@OrganiserADID
                ,MI.ChatId
                ,MI.EventType
                ,@MeetingId
                ,0
                ,1
            FROM @MeetingInstances MI
            WHERE MI.EventId NOT IN 
            (
                SELECT EventId
                FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
                WHERE
                (
                    MeetingId = @MeetingId
                    OR 
                    ParentMeetingId = @MeetingId
                )
                AND IsActive=1
            )

            IF @@ERROR<>0
            BEGIN
                ROLLBACK TRANSACTION
                SELECT 
	                'Something went wrong, unable to create recurrence meeting'	AS [Message],
	                ''						                                    AS ErrorMessage,
	                0						                                    AS [Status],
	                @MeetingId			                            AS Id,
	                ''						                                    AS ReferenceNo
                RETURN 
            END

            -- INSERT INTO MEETING PARTICIPANTS FOR ALL INSTANCES
            INSERT INTO dbo.[Trn_MeetingParticipants]
	        (
		         MeetingId
                ,ParticipantType
                ,ParticipantName
                ,ParticipantEmail
                ,ParticipantADID
                ,CreatedOn
                ,Active
	        )
            SELECT 
                 MD.MeetingId
                ,ParticipantType
                ,ParticipantName
                ,ParticipantEmail
                ,ParticipantADID
                ,GETUTCDATE()
                ,1
            FROM dbo.[Trn_MeetingDetails] MD WITH(NOLOCK)
            INNER JOIN dbo.[Trn_MeetingParticipants] MP WITH(NOLOCK) ON MD.ParentMeetingId=MP.MeetingId
		    WHERE MD.ParentMeetingId=@MeetingId
            AND MD.IsActive = 1
            AND MP.Active = 1
		    ORDER BY MD.MeetingId

            IF @@ERROR<>0
	        BEGIN
		        ROLLBACK TRANSACTION
		        SELECT 
			        'Something went wrong, unable to add meeting participants for recurrence meeting'   AS [Message],
			        ''						    AS ErrorMessage,
			        0						    AS [Status],
			        @MeetingId		AS Id,
			        ''						    AS ReferenceNo
		        RETURN 
	        END
           END

         -- INSERT ISCONDUCTED MEETING IN MEETING DETAILS
         IF EXISTS ( SELECT TOP 1 MeetingId FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK) WHERE SeriesMasterId=ISNULL(@SeriesMasterId,'') AND IsActive=0 AND IsConducted=1 )
         BEGIN
            UPDATE MD1
            SET MD1.IsConducted =
            ISNULL((
                SELECT TOP 1 IsConducted FROM dbo.[Trn_MeetingDetails] MD2
                WHERE MD2.IsActive = 0
                AND	MD2.ParentMeetingId = @MeetingId
                AND CONVERT(DATE,MD2.StartDateTime,103) = CONVERT(DATE,MD1.StartDateTime,103)
                ORDER BY MD2.MeetingId DESC
            ),0)
            FROM dbo.[Trn_MeetingDetails] MD1 WITH(NOLOCK)
            WHERE MD1.IsActive = 1
            AND MD1.MeetingId != @MeetingId
            AND MD1.ParentMeetingId = @MeetingId
         END
        
        -- IF MONTHLY MEETING
         IF (@RepeatOption = 'AbsoluteMonthly' OR @RepeatOption = 'RelativeMonthly' OR @RepeatOption = 'AbsoluteYearly' OR @RepeatOption = 'RelativeYearly')
         BEGIN
            -- CREATE TEMP TABLE
            DECLARE  @MeetingDetailsNew TABLE
	        (
	            AutoId BIGINT IDENTITY(1,1),
	            MeetingId BIGINT,
	            ParentMeetingId BIGINT
	        )
            -- SAVE UPDATED MEETING DETAILS IN A TEMP TABLE
            INSERT INTO @MeetingDetailsNew
            (
                MeetingId
                ,ParentMeetingId
            )
            SELECT 
                MeetingId
                ,ParentMeetingId
            FROM dbo.[Trn_MeetingDetails] WITH(NOLOCK)
            WHERE
            (
                MeetingId = @MeetingId
                OR
                ParentMeetingId = @MeetingId
            )
            AND IsActive=1

            -- UPDATE FILE UPLOAD
            IF EXISTS (SELECT TOP 1 MeetingId FROM dbo.[Trn_MeetingFileUpload] WHERE MeetingId = @MeetingId OR MeetingId IN (SELECT MeetingId FROM @MeetingDetailsOld WHERE ParentMeetingId = @MeetingId) AND IsActive = 1)
            BEGIN                
                UPDATE MFU
                SET MFU.MeetingId = TMP.NewMeetingId
                FROM Trn_MeetingFileUpload MFU,
                (
                    SELECT Old.MeetingId AS OldMeetingId,
                    NEW.MeetingId as NewMeetingId
                    FROM @MeetingDetailsOld Old, 
                    @MeetingDetailsNew New
                    WHERE Old.AutoId = New.AutoId 
                ) TMP
                WHERE MFU.MeetingId = TMP.OldMeetingId
            END
            ---- UPDATE TASK DETAILS
            --IF EXISTS (SELECT TOP 1 MeetingId FROM dbo.[Trn_TaskDetails] WHERE MeetingId = @MeetingId OR MeetingId IN (SELECT MeetingId FROM @MeetingDetailsOld WHERE ParentMeetingId = @MeetingId))
            --BEGIN
            --    UPDATE TD
            --    SET TD.MeetingId = TMP.NewMeetingId
            --    FROM dbo.[Trn_TaskDetails] TD,
            --    (
            --        SELECT Old.MeetingId AS OldMeetingId,
            --        NEW.MeetingId as NewMeetingId
            --        FROM @MeetingDetailsOld Old, 
            --        @MeetingDetailsNew New
            --        WHERE Old.AutoId = New.AutoId 
            --    ) TMP
            --    WHERE TD.MeetingId = TMP.OldMeetingId
            --END
             -- UPDATE SPO FILE UPLOAD
            IF EXISTS (SELECT TOP 1 MeetingId FROM dbo.[MeetingSPOFileUploadResponse] WHERE MeetingId = @MeetingId OR MeetingId IN (SELECT MeetingId FROM @MeetingDetailsOld WHERE ParentMeetingId = @MeetingId) AND IsActive = 1)
            BEGIN                
                UPDATE RES
                SET RES.MeetingId = TMP.NewMeetingId
                FROM MeetingSPOFileUploadResponse RES WITH(NOLOCK),
                (
                    SELECT Old.MeetingId AS OldMeetingId,
                    NEW.MeetingId as NewMeetingId
                    FROM @MeetingDetailsOld Old, 
                    @MeetingDetailsNew New
                    WHERE Old.AutoId = New.AutoId 
                ) TMP
                WHERE RES.MeetingId = TMP.OldMeetingId
            END
        END

       END

    COMMIT TRANSACTION
	SELECT 
		'Meeting details updated successfully'      AS	[Message],
		''								            AS ErrorMessage,
		1								            AS [Status],
		@MeetingId					                AS Id,
	    ''					                        AS ReferenceNo
END
GO
PRINT N'Refreshing Procedure [dbo].[usp_CallRecord_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_CallRecord_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Check_MeetingDetailsBeforeCancel]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Check_MeetingDetailsBeforeCancel]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Check_MeetingDetailsBeforeUpdate2]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Check_MeetingDetailsBeforeUpdate2]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Check_MeetingDetailsByJoinUrl]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Check_MeetingDetailsByJoinUrl]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_Conf_Room_Details]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_Conf_Room_Details]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_DivisionHead_MeetingDetails]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_DivisionHead_MeetingDetails]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_DivisionHead_TaskDetails]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_DivisionHead_TaskDetails]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_DivisionHead_TaskDetails_UserWise]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_DivisionHead_TaskDetails_UserWise]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_FeedBack_Details]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_FeedBack_Details]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_Personal_TaskDetails_ByMeetingID]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_Personal_TaskDetails_ByMeetingID]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_Personal_TaskDetailsByUser]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_Personal_TaskDetailsByUser]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_Personal_TaskDetailsToUser]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_Personal_TaskDetailsToUser]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_ReportingManager_MeetingDetails]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_ReportingManager_MeetingDetails]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Dashboard_ReportingManager_TaskDetails]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Dashboard_ReportingManager_TaskDetails]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Division_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Division_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_Get_ForSendingMail]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_Get_ForSendingMail]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_GetForAttachmentNotification]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_GetForAttachmentNotification]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_GetSeriesMeetingId]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_GetSeriesMeetingId]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_GetSeriesMeetingIdAfterMeetingUpdate]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_GetSeriesMeetingIdAfterMeetingUpdate]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_Partially]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_Partially]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_ParticipantsUpdate]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_ParticipantsUpdate]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingDetails_SendMail]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingDetails_SendMail]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingFileUpload_AnchorUpdate2]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingFileUpload_AnchorUpdate2]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingFileUpload_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingFileUpload_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingTitle_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingTitle_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingType_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingType_Delete]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_MeetingUpdateFileUpload_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_MeetingUpdateFileUpload_Insert]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_TaskDetails_Get]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_TaskDetails_Get]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_TaskDetails_GetAll]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_TaskDetails_GetAll]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_TaskDetails_GetAllPrev]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_TaskDetails_GetAllPrev]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_TaskDetails_GetByReferenceNo]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_TaskDetails_GetByReferenceNo]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_TaskDetails_ReassignDetails_Get]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_TaskDetails_ReassignDetails_Get]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_TaskDetailsGet_SendReminderNotification]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_TaskDetailsGet_SendReminderNotification]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Vertical_Delete]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Vertical_Delete]';


GO
PRINT N'Update complete.';


GO
